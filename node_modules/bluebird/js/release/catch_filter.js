"use strict";
module.exports = function(NEXT_FILTER) {
let util = require("./util");
let getKeys = require("./es5").keys;
let tryCatch = util.tryCatch;
let errorObj = util.errorObj;

function catchFilter(instances, cb, promise) {
    return function(e) {
        let boundTo = promise._boundValue();
        predicateLoop: for (let i = 0; i < instances.length; ++i) {
            let item = instances[i];

            if (item === Error ||
                (item != null && item.prototype instanceof Error)) {
                if (e instanceof item) {
                    return tryCatch(cb).call(boundTo, e);
                }
            } else if (typeof item === "function") {
                let matchesPredicate = tryCatch(item).call(boundTo, e);
                if (matchesPredicate === errorObj) {
                    return matchesPredicate;
                } else if (matchesPredicate) {
                    return tryCatch(cb).call(boundTo, e);
                }
            } else if (util.isObject(e)) {
                let keys = getKeys(item);
                for (let j = 0; j < keys.length; ++j) {
                    let key = keys[j];
                    if (item[key] != e[key]) {
                        continue predicateLoop;
                    }
                }
                return tryCatch(cb).call(boundTo, e);
            }
        }
        return NEXT_FILTER;
    };
}

return catchFilter;
};
